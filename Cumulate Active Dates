DROP TABLE IF EXISTS users_cumulated
CREATE TABLE users_cumulated(
	user_id TEXT,
	dates_active DATE[],
	date DATE,
	PRIMARY KEY (user_id, date)
)


WITH yesterday AS (
	SELECT * FROM users_cumulated 
	WHERE date = DATE '2022-12-31'
),today AS (
	SELECT CAST(user_id AS TEXT), COUNT(1),DATE(event_time) AS date_active
	FROM events 
	WHERE DATE(event_time) = DATE '2023-01-01'
	AND user_id IS NOT NULL
	GROUP BY user_id,DATE(event_time)
)


INSERT INTO users_cumulated
SELECT COALESCE(t.user_id,y.user_id),

/*cumulate active dates*/
CASE 
	WHEN y.dates_active IS NULL THEN ARRAY[t.date_active]
	WHEN t.date_active IS NULL THEN y.dates_active
	ELSE ARRAY[t.date_active] || y.dates_active 
	END
	AS dates_active,
	
COALESCE(t.date_active,y.date+Interval '1 day') AS date

FROM today t
FULL OUTER JOIN yesterday y
ON t.user_id = y.user_id 
